<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/admin.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script> <!-- âœ… Tambah Socket.IO -->
  <style>
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    body { overflow-x: hidden; overflow-y: auto; }
    main { max-width: 100%; overflow-x: hidden; }
    table { table-layout: fixed; }
    /* ðŸ”´ Badge Notifikasi */
    #pesananBadge {
      position: absolute;
      top: 10px;
      right: 14px;
      background-color: #ef4444;
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 9999px;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- Sidebar -->
  <%- include('partials/sidebarAdmin') %>

  <!-- âœ… Badge indikator di sidebar (bisa letakkan di partial juga) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pesananLink = document.getElementById('menu-pesanan');
      if (pesananLink && !document.getElementById('pesananBadge')) {
        const badge = document.createElement('span');
        badge.id = 'pesananBadge';
        badge.textContent = '0';
        pesananLink.style.position = 'relative';
        pesananLink.appendChild(badge);
      }
    });
  </script>

  <!-- Konten utama -->
  <main class="flex-1 ml-64 p-6">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Manajemen Pesanan</h1>
      <p class="text-gray-600">Monitor dan kelola status pesanan pelanggan</p>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <!-- Card 1: Menunggu Pembayaran -->
      <div class="stat-card bg-white rounded-lg shadow-md p-5 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-gray-600 uppercase tracking-wide">Menunggu Pembayaran</p>
            <p id="count-menunggu" class="text-3xl font-bold text-gray-800 mt-2">
              <%= pesanan.filter(p => p.status_pesanan === 'Menunggu Pembayaran').length %>
            </p>
          </div>
          <div class="bg-yellow-100 rounded-full p-3">
            <svg class="w-7 h-7 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Card 2: Diproses -->
      <div class="stat-card bg-white rounded-lg shadow-md p-5 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-gray-600 uppercase tracking-wide">Diproses</p>
            <p id="count-diproses" class="text-3xl font-bold text-gray-800 mt-2">
              <%= pesanan.filter(p => p.status_pesanan === 'Diproses').length %>
            </p>
          </div>
          <div class="bg-blue-100 rounded-full p-3">
            <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Card 3: Selesai -->
      <div class="stat-card bg-white rounded-lg shadow-md p-5 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-gray-600 uppercase tracking-wide">Selesai</p>
            <p id="count-selesai" class="text-3xl font-bold text-gray-800 mt-2">
              <%= pesanan.filter(p => p.status_pesanan === 'Selesai').length %>
            </p>
          </div>
          <div class="bg-green-100 rounded-full p-3">
            <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">Daftar Pesanan</h2>
      </div>

      <div id="pesananTable" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ID</th>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Tanggal</th>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Meja</th>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Menu</th>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Total</th>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status</th>
              <th class="px-5 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Aksi</th>
            </tr>
          </thead>
          <tbody id="pesananBody" class="bg-white divide-y divide-gray-200">
            <%- include('partials/pesananRows', { pesanan: pesanan }) %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- âœ… Socket.IO untuk Realtime Update -->
  <script>
    const socket = io();

    // Saat pesanan baru masuk dari user
    socket.on("pesananBaru", (data) => {
      console.log("ðŸŸ¢ Pesanan baru:", data);
      // Tampilkan badge merah di sidebar
      const badge = document.getElementById("pesananBadge");
      if (badge) {
        badge.style.display = "inline-block";
        badge.textContent = parseInt(badge.textContent || 0) + 1;
      }

      // Ambil ulang tabel tanpa reload penuh
      fetch(window.location.href)
        .then((res) => res.text())
        .then((html) => {
          const doc = new DOMParser().parseFromString(html, "text/html");
          const newTable = doc.querySelector("#pesananBody");
          document.querySelector("#pesananBody").innerHTML = newTable.innerHTML;

          // Update juga jumlah status di card atas
          document.getElementById("count-menunggu").textContent =
            doc.querySelector("#count-menunggu").textContent;
          document.getElementById("count-diproses").textContent =
            doc.querySelector("#count-diproses").textContent;
          document.getElementById("count-selesai").textContent =
            doc.querySelector("#count-selesai").textContent;
        });
    });
  </script>
</body>
</html>
